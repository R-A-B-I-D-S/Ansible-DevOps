---
- name: ‚ûï –°–æ–∑–¥–∞—Ç—å A-–∑–∞–ø–∏—Å—å –¥–ª—è —Å—É–±–¥–æ–º–µ–Ω–∞
  hosts: localhost
  gather_facts: no
  vars_prompt:
    - name: subdomain
      prompt: "–ò–º—è —Å—É–±–¥–æ–º–µ–Ω–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, demo)"
      private: no
    - name: target_ip
      prompt: "IP-–∞–¥—Ä–µ—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1.1.1.1)"
      private: no

  tasks:

#    - name: üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ A-–∑–∞–ø–∏—Å—å
#      uri:
#        url: "https://api.porkbun.com/api/json/v3/dns/retrieve/    {{ porkbun_domain }}"
#        method: POST
#        body:
#          apikey: "{{ porkbun_api_key }}"
#          secretapikey: "{{ porkbun_secret_api_key }}"
#        body_format: json
#        return_content: yes
#      register: existing

#    - name: üß© –ü–æ–∏—Å–∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∑–∞–ø–∏—Å–∏
#      set_fact:
#        record_exists: true
#      when: item.name == (subdomain + '.' + porkbun_domain) and item.type == "A"
#      loop: "{{ existing.json.records }}"

    - name: üöÄ –°–æ–∑–¥–∞—Ç—å A-–∑–∞–ø–∏—Å—å
      when: record_exists is not defined
      uri:
        url: "https://api.porkbun.com/api/json/v3/dns/create/{{ porkbun_domain }}"
        method: POST
        body:
          apikey: "{{ porkbun_api_key }}"
          secretapikey: "{{ porkbun_secret_api_key }}"
          name: "{{ subdomain }}"
          type: "A"
          content: "{{ target_ip }}"
          ttl: "300"
        body_format: json
        status_code: 200
      register: create_result

    - name: ‚úÖ –û—Ç—á—ë—Ç
      debug:
        msg: "{{ '‚úÖ –°–æ–∑–¥–∞–Ω–∞: ' + subdomain + '.' + porkbun_domain + ' ‚Üí ' + target_ip if create_result is succeeded else 'üü° –£–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç' }}"
