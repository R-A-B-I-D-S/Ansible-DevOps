---
- name: üîÅ –ó–∞–º–µ–Ω–∏—Ç—å IP A-–∑–∞–ø–∏—Å–∏ (—É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—É—é ‚Üí —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é)
  hosts: localhost
  gather_facts: no
  vars_files:
    - ../porkbun.yml

  vars_prompt:
    - name: subdomain
      prompt: "–ò–º—è —Å—É–±–¥–æ–º–µ–Ω–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, blog, admin)"
      private: no
    - name: old_ip
      prompt: "–°—Ç–∞—Ä—ã–π IP-–∞–¥—Ä–µ—Å (–∫–æ—Ç–æ—Ä—ã–π –Ω—É–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å)"
      private: no
    - name: new_ip
      prompt: "–ù–æ–≤—ã–π IP-–∞–¥—Ä–µ—Å (–∫–æ—Ç–æ—Ä—ã–π –Ω—É–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å)"
      private: no

  tasks:
    - name: üß™ –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
      debug:
        msg: |
          –¶–µ–ª—å: {{ subdomain }}.{{ porkbun_domain }}
          –£–¥–∞–ª–∏—Ç—å: ‚Üí {{ old_ip }}
          –°–æ–∑–¥–∞—Ç—å: ‚Üí {{ new_ip }}

    # --- –®–ê–ì 1: –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∑–∞–ø–∏—Å–∏ ---
    - name: üîç –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ DNS-–∑–∞–ø–∏—Å–∏ –∏–∑ Porkbun
      uri:
        url: "https://api.porkbun.com/api/json/v3/dns/retrieve/{{ porkbun_domain }}"
        method: POST
        body:
          apikey: "{{ porkbun_api_key }}"
          secretapikey: "{{ porkbun_secret_api_key }}"
        body_format: json
        return_content: yes
      register: dns_response

    - name: ‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä–∫–∞:API –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É
      fail:
        msg: "‚ùå –û—à–∏–±–∫–∞ API {{ dns_response.json.status }} ‚Äî {{ dns_response.json.message | default('Unknown error') }}"
      when: dns_response.json is defined and dns_response.json.status != "SUCCESS"

    # --- –®–ê–ì 2: –ü–æ–∏—Å–∫ —Å—Ç–∞—Ä–æ–π –∑–∞–ø–∏—Å–∏ (–¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è) ---
    - name: üß© –ù–∞–π—Ç–∏ A-–∑–∞–ø–∏—Å—å {{ subdomain }} ‚Üí {{ old_ip }}
      set_fact:
        record_to_delete: "{{ item }}"
      loop: "{{ dns_response.json.records }}"
      when: >
        item.type == 'A' and
        item.name == (subdomain + '.' + porkbun_domain) and
        item.content == old_ip | trim

    # --- –®–ê–ì 3: –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–π –∑–∞–ø–∏—Å–∏ ---
    - name: üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—É—é A-–∑–∞–ø–∏—Å—å {{ subdomain }} ‚Üí {{ old_ip }}
      uri:
        url: "https://api.porkbun.com/api/json/v3/dns/delete/{{ porkbun_domain }}/{{ record_to_delete.id }}"
        method: POST
        body:
          apikey: "{{ porkbun_api_key }}"
          secretapikey: "{{ porkbun_secret_api_key }}"
        body_format: json
        status_code: 200
      register: delete_result
      when: record_to_delete is defined

    - name: ‚úÖ –£—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞ —Å—Ç–∞—Ä–∞—è –∑–∞–ø–∏—Å—å
      debug:
        msg: "‚úÖ –£–¥–∞–ª–µ–Ω–æ: {{ subdomain }}.{{ porkbun_domain }} ‚Üí {{ old_ip }}"
      when: record_to_delete is defined and delete_result is succeeded

    - name: ‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–∞ –∑–∞–ø–∏—Å—å –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
      debug:
        msg: "üü° –ù–µ –Ω–∞–π–¥–µ–Ω–∞ A-–∑–∞–ø–∏—Å—å {{ subdomain }}.{{ porkbun_domain }} ‚Üí {{ old_ip }}"
      when: record_to_delete is not defined

    - name: ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏
      debug:
        msg: "‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è {{ delete_result.status }} {{ delete_result.status_text }}"
      when: record_to_delete is defined and delete_result is failed

    # --- –®–ê–ì 4: –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∑–∞–ø–∏—Å–∏ ---
    - name: üöÄ –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é A-–∑–∞–ø–∏—Å—å {{ subdomain }} ‚Üí {{ new_ip }}
      uri:
        url: "https://api.porkbun.com/api/json/v3/dns/create/{{ porkbun_domain }}"
        method: POST
        body:
          apikey: "{{ porkbun_api_key }}"
          secretapikey: "{{ porkbun_secret_api_key }}"
          name: "{{ subdomain }}"
          type: "A"
          content: "{{ new_ip }}"
          ttl: "300"
        body_format: json
        status_code: 200
      register: create_result
      # –°–æ–∑–¥–∞—ë–º –≤—Å–µ–≥–¥–∞, –¥–∞–∂–µ –µ—Å–ª–∏ —Å—Ç–∞—Ä–∞—è –∑–∞–ø–∏—Å—å –Ω–µ –±—ã–ª–∞ –Ω–∞–π–¥–µ–Ω–∞ ‚Äî –º–æ–∂–µ—Ç, –æ–Ω–∞ —É–∂–µ —É–¥–∞–ª–µ–Ω–∞
      # –ï—Å–ª–∏ –∑–∞–ø–∏—Å—å —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç —Å –Ω–æ–≤—ã–º IP ‚Äî API –≤–µ—Ä–Ω—ë—Ç –æ—à–∏–±–∫—É

    - name: ‚úÖ –£—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞ –Ω–æ–≤–∞—è –∑–∞–ø–∏—Å—å
      debug:
        msg: "‚úÖ –°–æ–∑–¥–∞–Ω–æ: {{ subdomain }}.{{ porkbun_domain }} ‚Üí {{ new_ip }}"
      when: create_result is succeeded

    - name: ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏
      debug:
        msg: |-
          ‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è {{ create_result.json.message | default('HTTP ' + create_result.status|string) }}
          –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã
          ‚Ä¢ –£–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç A-–∑–∞–ø–∏—Å—å —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º
          ‚Ä¢ –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
          ‚Ä¢ –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π IP
      when: create_result is failed
