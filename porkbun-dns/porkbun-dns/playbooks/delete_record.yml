# playbooks/delete_record.yml
---
- name: ‚ùå –£–¥–∞–ª–∏—Ç—å A-–∑–∞–ø–∏—Å—å –ø–æ —Å—É–±–¥–æ–º–µ–Ω—É –∏ IP
  hosts: localhost
  gather_facts: no
  vars_files:
    - ../porkbun.yml

  vars_prompt:
    - name: subdomain
      prompt: "–ò–º—è —Å—É–±–¥–æ–º–µ–Ω–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, demo –∏–ª–∏ blog)"
      private: no
    - name: target_ip
      prompt: "IP-–∞–¥—Ä–µ—Å –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1.1.1.1)"
      private: no

  tasks:
    - name: üß™ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
      debug:
        msg: |
          Domain: {{ porkbun_domain }}
          Subdomain: {{ subdomain }}
          Target IP: {{ target_ip }}

    - name: üîç –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ DNS-–∑–∞–ø–∏—Å–∏ –∏–∑ Porkbun
      uri:
        url: "https://api.porkbun.com/api/json/v3/dns/retrieve/{{ porkbun_domain }}"
        method: POST
        body:
          apikey: "{{ porkbun_api_key }}"
          secretapikey: "{{ porkbun_secret_api_key }}"
        body_format: json
        return_content: yes
      register: dns_response

    - name: ‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä–∫–∞API –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É
      fail:
        msg: "‚ùå –û—à–∏–±–∫–∞ API {{ dns_response.json.status }} ‚Äî {{ dns_response.json.message | default('Unknown error') }}"
      when: dns_response.json is defined and dns_response.json.status != "SUCCESS"

    - name: üß© –ù–∞–π—Ç–∏ A-–∑–∞–ø–∏—Å—å —Å –∏–º–µ–Ω–µ–º {{ subdomain }} –∏ IP {{ target_ip }}
      set_fact:
        target_record: "{{ item }}"
      loop: "{{ dns_response.json.records }}"
      when: >
        item.type == 'A' and
        item.name == (subdomain + '.' + porkbun_domain) and
        item.content == target_ip | trim

    - name: üö´ –ù–µ—Ç —Å–æ–≤–ø–∞–¥–∞—é—â–µ–π A-–∑–∞–ø–∏—Å–∏
      debug:
        msg: "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–æ A-–∑–∞–ø–∏—Å–∏ {{ subdomain }}.{{ porkbun_domain }} ‚Üí {{ target_ip }}"
      when: target_record is not defined

    - name: üóëÔ∏è –£–¥–∞–ª–∏—Ç—å A-–∑–∞–ø–∏—Å—å —á–µ—Ä–µ–∑ API
      uri:
        url: "https://api.porkbun.com/api/json/v3/dns/delete/{{ porkbun_domain }}/{{ target_record.id }}"
        method: POST
        body:
          apikey: "{{ porkbun_api_key }}"
          secretapikey: "{{ porkbun_secret_api_key }}"
        body_format: json
        status_code: 200
      register: delete_result
      when: target_record is defined

    - name: ‚úÖ –û—Ç—á—ë—Ç –æ–± —É–¥–∞–ª–µ–Ω–∏–∏
      debug:
        msg: >-
          {% if delete_result is succeeded %}
          ‚úÖ –£—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞ {{ subdomain }}.{{ porkbun_domain }} ‚Üí {{ target_ip }}
          {% else %}
          ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ {{ delete_result.status }} {{ delete_result.status_text }}
          {% endif %}
      when: target_record is defined
