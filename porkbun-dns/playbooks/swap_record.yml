---
- name: üîÅ –ó–∞–º–µ–Ω–∏—Ç—å IP A-–∑–∞–ø–∏—Å–∏ (—É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—É—é ‚Üí —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é)
  hosts: localhost
  gather_facts: no

  tasks:
    # --- –®–ê–ì 1: –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∑–∞–ø–∏—Å–∏ ---
    - name: üîç –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ DNS-–∑–∞–ø–∏—Å–∏ –∏–∑ Porkbun
      uri:
        url: "https://api.porkbun.com/api/json/v3/dns/retrieve/{{ porkbun_domain }}"
        method: POST
        body:
          apikey: "{{ porkbun_api_key }}"
          secretapikey: "{{ porkbun_secret_api_key }}"
        body_format: json
        return_content: yes
      register: dns_response

    - name: ‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä–∫–∞:API –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É
      fail:
        msg: "‚ùå –û—à–∏–±–∫–∞ API {{ dns_response.json.status }} ‚Äî {{ dns_response.json.message | default('Unknown error') }}"
      when: dns_response.json is defined and dns_response.json.status != "SUCCESS"

    - name: üß© –ò–∑–≤–ª–µ—á—å –∏ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å A-–∑–∞–ø–∏—Å–∏
      set_fact:
        a_records: >-
          {{
            dns_response.json.records
            | selectattr('type', 'equalto', 'A')
            | sort(attribute='name')
            | list
          }}

    - name: üìÑ –í—ã–≤–µ—Å—Ç–∏ —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö A-–∑–∞–ø–∏—Å–µ–π
      debug:
        msg: |-
          –°–ü–ò–°–û–ö A-–ó–ê–ü–ò–°–ï–ô –î–õ–Ø {{ porkbun_domain }}

          {% for record in a_records %}
          {{ "%2d" % loop.index }}) {{ "%-30s" % record.name }} ‚Üí {{ record.content }}
          {% endfor %}
      when: a_records | length > 0

    - name: üü° –ù–µ—Ç A-–∑–∞–ø–∏—Å–µ–π –¥–ª—è –¥–æ–º–µ–Ω–∞
      debug:
        msg: |-
           –ù–ï–¢ A-–ó–ê–ü–ò–°–ï–ô –¥–ª—è –¥–æ–º–µ–Ω–∞ {{ porkbun_domain }}
      when: a_records | length == 0

    - name: üß© –ó–∞–ø—Ä–æ—Å–∏—Ç—å –∏–º—è —Å—É–±–¥–æ–º–µ–Ω–∞
      pause:
        prompt: "–í–≤–µ–¥–∏—Ç–µ –∏–º—è —Å—É–±–¥–æ–º–µ–Ω–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, demo) –¥–ª—è –¥–æ–º–µ–Ω–∞ 2-–≥–æ —É—Ä–æ–≤–Ω—è {{ porkbun_domain }}"
      register: subdomain_input

    - name: üß© –ó–∞–ø—Ä–æ—Å–∏—Ç—å IP-–∞–¥—Ä–µ—Å –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
      pause:
        prompt: "–í–≤–µ–¥–∏—Ç–µ IP-–∞–¥—Ä–µ—Å –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1.1.1.1)"
      register: old_ip_input

    - name: üß© –ó–∞–ø—Ä–æ—Å–∏—Ç—å IP-–∞–¥—Ä–µ—Å –¥–ª—è –Ω–æ–≤–æ–π –∑–∞–ø–∏—Å–∏
      pause:
        prompt: "–í–≤–µ–¥–∏—Ç–µ IP-–∞–¥—Ä–µ—Å –¥–ª—è –Ω–æ–≤–æ–π –∑–∞–ø–∏—Å–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1.1.1.1)"
      register: new_ip_input

    - name: üß© –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–≤–µ–¥—ë–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
      set_fact:
        subdomain: "{{ subdomain_input.user_input }}"
        old_ip: "{{ old_ip_input.user_input }}"
        new_ip: "{{ new_ip_input.user_input }}"

    - name:  üìÑ –í—ã–≤–µ—Å—Ç–∏ –≤–≤–µ–¥–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
      debug:
        msg: |-
           –î–æ–º–µ–Ω  ‚Üí {{subdomain}}.{{porkbun_domain}}
           –°—Ç–∞—Ä—ã–π IP  ‚Üí {{old_ip}}
           –ù–æ–≤—ã–π IP  ‚Üí {{new_ip}}

    # --- –®–ê–ì 2: –ü–æ–∏—Å–∫ —Å—Ç–∞—Ä–æ–π –∑–∞–ø–∏—Å–∏ (–¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è) ---
    - name: üß© –ù–∞–π—Ç–∏ A-–∑–∞–ø–∏—Å—å {{ subdomain }} ‚Üí {{ old_ip }}
      set_fact:
        record_to_delete: "{{ item }}"
      loop: "{{ dns_response.json.records }}"
      when: >
        item.type == 'A' and
        item.name == (subdomain + '.' + porkbun_domain) and
        item.content == old_ip | trim

    - name: –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ => –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–≤–µ–¥–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
      debug:
        msg: |-
          –î–û–ú–ï–ù  ‚Üí {{ subdomain }}.{{ porkbun_domain }}

          –°–¢–ê–†–´–ô IP  ‚Üí {{ old_ip }}

          –ù–û–í–´–ô IP  ‚Üí {{ new_ip }}

          –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–≤–µ–¥–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ!!!!!!!!!

    - name: üõë –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–æ–¥–º–µ–Ω—É –∑–∞–ø–∏—Å–∏
      pause:
        prompt: "–í–≤–µ–¥–∏—Ç–µ 'yes' –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–æ–¥–º–µ–Ω—ã, –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C –¥–ª—è –æ—Ç–º–µ–Ω—ã"
      register: confirmation_pause

    # --- –®–ê–ì 3: –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–π –∑–∞–ø–∏—Å–∏ ---
    - name: üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—É—é A-–∑–∞–ø–∏—Å—å {{ subdomain }} ‚Üí {{ old_ip }}
      uri:
        url: "https://api.porkbun.com/api/json/v3/dns/delete/{{ porkbun_domain }}/{{ record_to_delete.id }}"
        method: POST
        body:
          apikey: "{{ porkbun_api_key }}"
          secretapikey: "{{ porkbun_secret_api_key }}"
        body_format: json
        status_code: 200
      register: delete_result
      when: record_to_delete is defined

    - name: ‚úÖ –£—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞ —Å—Ç–∞—Ä–∞—è –∑–∞–ø–∏—Å—å
      debug:
        msg: "‚úÖ –£–¥–∞–ª–µ–Ω–æ: {{ subdomain }}.{{ porkbun_domain }} ‚Üí {{ old_ip }}"
      when: record_to_delete is defined and delete_result is succeeded


    - name: ‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–∞ –∑–∞–ø–∏—Å—å –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
      debug:
        msg: "üü° –ù–µ –Ω–∞–π–¥–µ–Ω–∞ A-–∑–∞–ø–∏—Å—å {{ subdomain }}.{{ porkbun_domain }} ‚Üí {{ old_ip }}"
      when: record_to_delete is not defined

    - name: ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏
      debug:
        msg: "‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è {{ delete_result.status }} {{ delete_result.status_text }}"
      when: record_to_delete is defined and delete_result is failed

    # --- –®–ê–ì 4: –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∑–∞–ø–∏—Å–∏ ---
    - name: üöÄ –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é A-–∑–∞–ø–∏—Å—å {{ subdomain }} ‚Üí {{ new_ip }}
      uri:
        url: "https://api.porkbun.com/api/json/v3/dns/create/{{ porkbun_domain }}"
        method: POST
        body:
          apikey: "{{ porkbun_api_key }}"
          secretapikey: "{{ porkbun_secret_api_key }}"
          name: "{{ subdomain }}"
          type: "A"
          content: "{{ new_ip }}"
          ttl: "300"
        body_format: json
        status_code: 200
      register: create_result
      # –°–æ–∑–¥–∞—ë–º –≤—Å–µ–≥–¥–∞, –¥–∞–∂–µ –µ—Å–ª–∏ —Å—Ç–∞—Ä–∞—è –∑–∞–ø–∏—Å—å –Ω–µ –±—ã–ª–∞ –Ω–∞–π–¥–µ–Ω–∞ ‚Äî –º–æ–∂–µ—Ç, –æ–Ω–∞ —É–∂–µ —É–¥–∞–ª–µ–Ω–∞
      # –ï—Å–ª–∏ –∑–∞–ø–∏—Å—å —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç —Å –Ω–æ–≤—ã–º IP ‚Äî API –≤–µ—Ä–Ω—ë—Ç –æ—à–∏–±–∫—É

    - name: ‚úÖ –£—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞ –Ω–æ–≤–∞—è –∑–∞–ø–∏—Å—å
      debug:
        msg: "‚úÖ –°–æ–∑–¥–∞–Ω–æ: {{ subdomain }}.{{ porkbun_domain }} ‚Üí {{ new_ip }}"
      when: create_result is succeeded

    - name: ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏
      debug:
        msg: |-
          ‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è {{ create_result.json.message | default('HTTP ' + create_result.status|string) }}
          –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã
          ‚Ä¢ –£–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç A-–∑–∞–ø–∏—Å—å —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º
          ‚Ä¢ –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
          ‚Ä¢ –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π IP
      when: create_result is failed
