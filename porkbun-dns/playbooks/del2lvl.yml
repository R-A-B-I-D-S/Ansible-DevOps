---
- name: üßπ –£–¥–∞–ª–∏—Ç—å A-–∑–∞–ø–∏—Å–∏ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –Ω–æ–¥ –∏–∑ Porkbun
  hosts: localhost
  gather_facts: no

  vars:
    domains_to_process: "{{ target_domains }}"  # –°–ø–∏—Å–æ–∫ –¥–æ–º–µ–Ω–æ–≤ 2-–≥–æ —É—Ä–æ–≤–Ω—è
    remnawave_api_url: "https://{{ remnawave_domain }}/api/nodes"

  tasks:

    # --- –®–ê–ì 1: –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –Ω–æ–¥ –∏–∑ Remnawave ---
    - name: üåê –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –Ω–æ–¥ –∏–∑ Remnawave
      uri:
        url: "{{ remnawave_api_url }}"
        method: GET
        headers:
          Authorization: "Bearer {{ remnawave_token }}"
        return_content: yes
        timeout: 30
      register: remnawave_response
      until: remnawave_response.status == 200
      retries: 3
      delay: 5

    - name: ‚ùå –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—à–∏–±–∫—É Remnawave API
      fail:
        msg: "Remnawave API error: {{ remnawave_response.json.message | default('Unknown error') }}"
      when: remnawave_response.json.errorCode is defined

    - name: üß© –í—ã–¥–µ–ª–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ –∏ –≤—Å–µ IP
      set_fact:
        active_ips: >-
          {{
            remnawave_response.json.response
            | selectattr('isNodeOnline', 'equalto', true)
            | map(attribute='address')
            | map('trim')
            | list
            | unique
          }}
        all_ips: >-
          {{
            remnawave_response.json.response
            | map(attribute='address')
            | map('trim')
            | list
            | unique
          }}

    - name: üìä –í—ã–≤–µ—Å—Ç–∏ –∞–∫—Ç–∏–≤–Ω—ã–µ IP
      debug:
        msg: |-
          –ê–∫—Ç–∏–≤–Ω—ã–µ IP: {{ active_ips }}

    # --- –®–ê–ì 2: –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ DNS-–∑–∞–ø–∏—Å–∏ ---
    - name: üîç –ü–æ–ª—É—á–∏—Ç—å DNS-–∑–∞–ø–∏—Å–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–æ–º–µ–Ω–∞
      uri:
        url: "https://api.porkbun.com/api/json/v3/dns/retrieve/{{ item }}"
        method: POST
        body:
          apikey: "{{ porkbun_api_key }}"
          secretapikey: "{{ porkbun_secret_api_key }}"
        body_format: json
        return_content: yes
      register: dns_results
      loop: "{{ domains_to_process }}"
      loop_control:
        label: "{{ item }}"

    - name: üß© –°–æ–±—Ä–∞—Ç—å –≤—Å–µ A-–∑–∞–ø–∏—Å–∏ –ø–æ –¥–æ–º–µ–Ω–∞–º
      set_fact:
        dns_a_map: >-
          {{
            dns_a_map | default({}) | combine({
              item: (
                (
                  (dns_results.results | selectattr('item', 'equalto', item) | first).json.records
                  | selectattr('type', 'equalto', 'A')
                  | selectattr('name', 'equalto', item)
                  | list
                )
              )
            })
          }}
      loop: "{{ domains_to_process }}"
      loop_control:
        label: "{{ item }}"

    - name: üêû DEBUG ‚Äî dns_a_map (–≤—Å–µ A-–∑–∞–ø–∏—Å–∏)
      debug:
        var: dns_a_map

    # --- –®–ê–ì 3: –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ IP (–µ—Å—Ç—å –≤ DNS, –Ω–æ –Ω–µ—Ç –≤ Remnawave) ---
    - name: üß© –ù–∞–π—Ç–∏ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ IP –ø–æ –¥–æ–º–µ–Ω–∞–º
      set_fact:
        inactive_ips_map: >-
          {{
            inactive_ips_map | default({}) | combine({
              domain: (
                (dns_a_map[domain] | map(attribute='content') | map('trim') | list)
                | difference(active_ips)
              )
            })
          }}
      loop: "{{ domains_to_process }}"
      loop_control:
        loop_var: domain
        label: "{{ domain }}"

    - name: üìã –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö IP
      debug:
        msg: |-
          –î–æ–º–µ–Ω: {{ domain }}
          –ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ IP –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è: {{ inactive_ips_map[domain] }}
      loop: "{{ domains_to_process }}"
      loop_control:
        label: "{{ domain }}"

    # --- –®–ê–ì 4: –£–¥–∞–ª–∏—Ç—å –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ IP ---
    - name: üóëÔ∏è –£–¥–∞–ª–∏—Ç—å A-–∑–∞–ø–∏—Å–∏ —Å –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–º–∏ IP
      uri:
        url: "https://api.porkbun.com/api/json/v3/dns/delete/{{ domain }}/{{ record.id }}"
        method: POST
        body:
          apikey: "{{ porkbun_api_key }}"
          secretapikey: "{{ porkbun_secret_api_key }}"
        body_format: json
        status_code: 200
      loop: "{{ dns_a_map[domain] | selectattr('content', 'in', inactive_ips_map[domain]) | list }}"
      loop_control:
        loop_var: record
        label: "{{ domain }} ‚Üí {{ record.content }}"
      vars:
        domain: "{{ item }}"
      with_items: "{{ domains_to_process }}"
      register: delete_results
      when: inactive_ips_map[domain] | length > 0

    # --- –®–ê–ì 5: –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á—ë—Ç ---
    - name: ‚úÖ –û—Ç—á—ë—Ç –æ–± —É–¥–∞–ª–µ–Ω–∏–∏
      debug:
        msg: |-
          –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ.
          {% for res in delete_results.results | default([]) %}
          - {{ res.item.0 if res.item is defined else '???' }} ‚Üí {{ res.invocation.module_args.url | regex_replace('.*/dns/delete/', '') }}
          {% endfor %}
      when: delete_results is defined

    - name: ‚ÑπÔ∏è –ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
      debug:
        msg: "–í—Å–µ DNS A-–∑–∞–ø–∏—Å–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –∞–∫—Ç–∏–≤–Ω—ã–º –Ω–æ–¥–∞–º ‚Äî —É–¥–∞–ª—è—Ç—å –Ω–µ—á–µ–≥–æ."
      when: delete_results is not defined
