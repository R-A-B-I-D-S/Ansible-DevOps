- name: Деплой и запуск ipregion.sh
  hosts: all
  become: yes
  serial: 10
  vars:
    ipregion_script_url: "https://raw.githubusercontent.com/Davoyan/ipregion/main/ipregion.sh"
    ipregion_script_path: "/usr/local/bin/ipregion.sh"
    ipregion_json_path: "/tmp/ipregion.json"
  tasks:
    - name: Проверить, есть ли уже ipregion.sh
      stat:
        path: "{{ ipregion_script_path }}"
      register: ipregion_exists

    - name: Скачать ipregion.sh, если его нет
      get_url:
        url: "{{ ipregion_script_url }}"
        dest: "{{ ipregion_script_path }}"
        mode: '0755'
      when: not ipregion_exists.stat.exists

    - name: Установить зависимости для (bash, curl, jq)
      package:
        name:
          - bash
          - curl
          - jq
          - bsdextrautils
          - bsdmainutils
          - ncal
        state: present

    - name: Запустить скрипт ipregion.sh с выводом в json
      command: "{{ ipregion_script_path }} --json"
      register: ipregion_json
      changed_when: false

    - name: Сохранить вывод в файл на сервере
      copy:
        content: "{{ ipregion_json.stdout }}"
        dest: "{{ ipregion_json_path }}"
        mode: '0644'

- name: Скачиваем json с серверов на ansible-управляющий сервер
  hosts: localhost
  gather_facts: yes
  vars:
    ipregion_output_dir: "/etc/ipregion"
    timestamp: "{{ ansible_date_time.iso8601_basic_short }}"
  tasks:
    - name: Создать директории для каждого сервера
      file:
        path: "{{ ipregion_output_dir }}/{{ hostvars[item]['server_name'] }}/"
        state: directory
        mode: '0755'
      loop: "{{ groups['servers'] }}"
      delegate_to: localhost

    - name: Скопировать ipregion.json с каждого сервера
      fetch:
        src: /tmp/ipregion.json
        dest: "{{ ipregion_output_dir }}/{{ hostvars[item]['server_name'] }}/ipregion-{{ hostvars[item]['server_name'] }}-{{ timestamp }}.json"
        flat: yes
      loop: "{{ groups['servers'] }}"
      delegate_to: "{{ item }}"

    - name: Найти все файлы ipregion для каждого сервера
      find:
        paths: "{{ ipregion_output_dir }}/{{ hostvars[item]['server_name'] }}/"
        patterns: "ipregion-{{ hostvars[item]['server_name'] }}-*.json"
      register: server_files
      loop: "{{ groups['servers'] }}"
      delegate_to: localhost

    - name: Переименовать файлы с нумерацией для каждого сервера
      shell: |
        cd "{{ ipregion_output_dir }}/{{ hostvars[item]['server_name'] }}/"
        
        # Создать временную директорию для сортировки
        mkdir -p temp_sort
        
        # Переместить все файлы (старые с нумерацией и новые) во временную директорию
        mv [0-9]-{{ hostvars[item]['server_name'] }}-*.json temp_sort/ 2>/dev/null || true
        mv ipregion-{{ hostvars[item]['server_name'] }}-*.json temp_sort/ 2>/dev/null || true
        
        # Переименовать все файлы с нумерацией, оставив только 3 самых новых
        counter=1
        for file in $(ls -t temp_sort/*.json); do
          if [ $counter -le 3 ]; then
            # Извлекаем только дату и время из имени файла
            filename=$(basename "$file")
            timestamp=$(echo "$filename" | sed "s/^[0-9]-{{ hostvars[item]['server_name'] }}-//" | sed "s/^ipregion-{{ hostvars[item]['server_name'] }}-//" | sed "s/\.json$//")
            mv "$file" "${counter}-{{ hostvars[item]['server_name'] }}-${timestamp}.json"
            counter=$((counter + 1))
          else
            rm -f "$file"
          fi
        done
        
        # Удалить временную директорию
        rmdir temp_sort 2>/dev/null || true
      loop: "{{ groups['servers'] }}"
      delegate_to: localhost

- import_playbook: ./ipregion_analyzer.yml