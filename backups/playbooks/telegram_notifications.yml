---
- name: "Telegram Notifications for Backup"
  hosts: localhost
  gather_facts: no
  vars:
      telegram_bot_token: "{{ telegram_bot_token | default('YOUR_BOT_TOKEN') }}"
      telegram_chat_id: "{{ telegram_chat_id | default('YOUR_CHAT_ID') }}"
      telegram_topic_id: "{{ telegram_topic_id | default('') }}"

  tasks:
      - name: "–°–±–æ—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ —Å–µ—Ä–≤–µ—Ä–∞–º"
        set_fact:
            backup_stats:
                total_servers: "{{ ansible_play_hosts | length }}"
                successful_servers: "{{ ansible_play_hosts | selectattr('ansible_failed', 'undefined') | list | length }}"
                failed_servers: "{{ ansible_play_hosts | selectattr('ansible_failed', 'defined') | list | length }}"
                servers_list: "{{ ansible_play_hosts }}"

      - name: "–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ–±—â–µ–≥–æ —Å—Ç–∞—Ç—É—Å–∞"
        set_fact:
            overall_status: "{{ 'success' if backup_stats.failed_servers == 0 else 'failed' }}"

      - name: "–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è"
        set_fact:
            servers_message: |
                {%- for host in backup_stats.servers_list -%}
                {%- if host.ansible_failed is defined -%}
                ‚ùå {{ host.inventory_hostname }} ({{ host.ansible_host }})
                {%- else -%}
                ‚úÖ {{ host.inventory_hostname }} ({{ host.ansible_host }})
                {%- endif -%}
                {%- if not loop.last %}
                {%- endif -%}
                {%- endfor -%}

      - name: "–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è Telegram"
        set_fact:
            telegram_message: |
                {%- if overall_status == 'success' -%}
                ü§ñ <b>BACKUP REPORT - –£–°–ü–ï–®–ù–û</b>
                {%- else -%}
                ü§ñ <b>BACKUP REPORT - –° –û–®–ò–ë–ö–ê–ú–ò</b>
                {%- endif %}
                
                üïê <b>–í—Ä–µ–º—è:</b> {{ ansible_date_time.iso8601 }}
                üìä <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</b> {{ backup_stats.successful_servers }}/{{ backup_stats.total_servers }} —Å–µ—Ä–≤–µ—Ä–æ–≤
                ‚è±Ô∏è <b>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</b> {{ ansible_date_time.epoch | int - playbook_start_time | default(ansible_date_time.epoch) | int }}s
                
                <b>üìã –î–µ—Ç–∞–ª–∏ –ø–æ —Å–µ—Ä–≤–µ—Ä–∞–º:</b>
                {{ servers_message }}
                
                {%- if backup_stats.failed_servers > 0 %}
                
                <b>üö® –û—à–∏–±–∫–∏:</b>
                {%- for host in backup_stats.servers_list -%}
                {%- if host.ansible_failed is defined %}
                ‚Ä¢ {{ host.inventory_hostname }}: {{ host.ansible_failed | default('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') }}
                {%- endif -%}
                {%- endfor %}
                {%- endif %}
                
                <i>ü§ñ Ansible Backup Bot</i>

      - name: "–û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram"
        uri:
            url: "https://api.telegram.org/bot{{ telegram_bot_token }}/sendMessage"
            method: POST
            body_format: json
            body:
                chat_id: "{{ telegram_chat_id }}"
                text: "{{ telegram_message }}"
                parse_mode: "HTML"
                disable_web_page_preview: true
                {%- if telegram_topic_id and telegram_topic_id != '' %}
                message_thread_id: "{{ telegram_topic_id }}"
                {%- endif %}
            status_code: 200
        register: telegram_result
        failed_when: false

      - name: "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏"
        debug:
            msg: "{{ '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ' if telegram_result.status == 200 else '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: ' + telegram_result.msg | default('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') }}"

      - name: "–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞"
        lineinfile:
            path: "{{ backup_output_dir | default('./backup_data') }}/telegram_notifications.log"
            line: "{{ ansible_date_time.iso8601 }} - {{ 'SUCCESS' if telegram_result.status == 200 else 'FAILED' }} - {{ backup_stats.successful_servers }}/{{ backup_stats.total_servers }} —Å–µ—Ä–≤–µ—Ä–æ–≤"
            create: yes
        delegate_to: localhost
        when: telegram_logging | default(true)
