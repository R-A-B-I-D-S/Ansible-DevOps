---
- name: üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ –Ω–æ–¥—ã Remnawave —Å DNS A-–∑–∞–ø–∏—Å—è–º–∏ –≤ Porkbun
  hosts: localhost
  gather_facts: no

  vars:
    # –†–∞–±–æ—Ç–∞–µ–º –Ω–∞–ø—Ä—è–º—É—é —Å target_domains ‚Äî —ç—Ç–æ –¥–æ–º–µ–Ω—ã 2-–≥–æ —É—Ä–æ–≤–Ω—è (apex)
    domains_to_process: "{{ target_domains }}"

  tasks:

    # --- –®–ê–ì 1: –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –Ω–æ–¥ –∏–∑ Remnawave API ---
    - name: üåê –ü–æ–ª—É—á–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ –Ω–æ–¥—ã –∏–∑ Remnawave
      uri:
        url: "https://{{ remnawave_domain }}/api/nodes"
        method: GET
        headers:
          Authorization: "Bearer {{ remnawave_token }}"
        return_content: yes
        timeout: 30
      register: remnawave_response
      until: remnawave_response.status == 200
      retries: 3
      delay: 5

    - name: ‚ùå –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—à–∏–±–∫—É Remnawave API
      fail:
        msg: "Remnawave API –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É: {{ remnawave_response.json.message | default('Unknown error') }}"
      when: remnawave_response.json is defined and remnawave_response.json.errorCode is defined

    - name: üß© –ò–∑–≤–ª–µ—á—å –∞–∫—Ç–∏–≤–Ω—ã–µ –Ω–æ–¥—ã (isNodeOnline == true)
      set_fact:
        active_nodes: >-
          {{
            remnawave_response.json.response
            | selectattr('isNodeOnline', 'equalto', true)
            | list
          }}

    - name: üìÑ –í—ã–≤–µ—Å—Ç–∏ —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –Ω–æ–¥
      debug:
        msg: |-
          –ê–ö–¢–ò–í–ù–´–ï –ù–û–î–´ ({{ active_nodes | length }} —à—Ç.):
          {% for node in active_nodes %}
          {{ "%2d" % loop.index }}) {{ node.name }} ‚Üí {{ node.address }}
          {% endfor %}
      when: active_nodes | length > 0

    - name: üü° –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –Ω–æ–¥ ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º DNS-–æ–ø–µ—Ä–∞—Ü–∏–∏
      debug:
        msg: "–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –Ω–æ–¥ –≤ Remnawave. –ù–∏—á–µ–≥–æ –¥–µ–ª–∞—Ç—å –Ω–µ –Ω—É–∂–Ω–æ."
      when: active_nodes | length == 0

    # --- –®–ê–ì 2: –î–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–æ–º–µ–Ω–∞ –ø–æ–ª—É—á–∏—Ç—å –≤—Å–µ DNS-–∑–∞–ø–∏—Å–∏ ---
    - name: üîç –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ DNS-–∑–∞–ø–∏—Å–∏ –¥–ª—è –¥–æ–º–µ–Ω–∞
      uri:
        url: "https://api.porkbun.com/api/json/v3/dns/retrieve/{{ item }}"
        method: POST
        body:
          apikey: "{{ porkbun_api_key }}"
          secretapikey: "{{ porkbun_secret_api_key }}"
        body_format: json
        return_content: yes
      register: dns_retrieve_results
      ignore_errors: yes
      loop: "{{ domains_to_process }}"
      loop_control:
        label: "{{ item }}"

    # --- –î–ï–ë–ê–ì: –í—ã–≤–µ—Å—Ç–∏ —Å—ã—Ä—ã–µ DNS-–∑–∞–ø–∏—Å–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ ---
    - name: üêû DEBUG ‚Äî –°—ã—Ä—ã–µ DNS-–∑–∞–ø–∏—Å–∏ –¥–ª—è –¥–æ–º–µ–Ω–∞
      debug:
        var: result.json.records
      loop: "{{ domains_to_process }}"
      loop_control:
        label: "{{ item }}"
      vars:
        result: "{{ dns_retrieve_results.results | selectattr('item', 'equalto', item) | first }}"
      when: result.json is defined and result.json.status == "SUCCESS"

    # --- –®–ê–ì 3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—à–∏–±–∫–∏ Porkbun API ---
    - name: ‚ùå –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—à–∏–±–∫—É Porkbun API –¥–ª—è –¥–æ–º–µ–Ω–∞
      fail:
        msg: "Porkbun API error for {{ item }}: {{ result.json.message | default('Unknown') }}"
      when: result.json is defined and result.json.status != "SUCCESS"
      loop: "{{ domains_to_process }}"
      loop_control:
        label: "{{ item }}"
      vars:
        result: "{{ dns_retrieve_results.results | selectattr('item', 'equalto', item) | first }}"

    - name: üß© –ü–æ—Å—Ç—Ä–æ–∏—Ç—å existing_ips_map (—Ç–æ–ª—å–∫–æ A-–∑–∞–ø–∏—Å–∏ –¥–ª—è apex-–¥–æ–º–µ–Ω–∞)
      set_fact:
        existing_ips_map: >-
          {{
            existing_ips_map | default({}) | combine({
              item: (
                (
                  (dns_retrieve_results.results | selectattr('item', 'equalto', item) | first | default({}))
                  .json.records | default([])
                )
                | selectattr('type', 'equalto', 'A')
                | selectattr('name', 'equalto', item)
                | map(attribute='content')
                | map('trim')
                | list
                | unique
              )
            })
          }}
      loop: "{{ domains_to_process }}"
      loop_control:
        label: "{{ item }}"

    # --- –î–ï–ë–ê–ì: –í—ã–≤–µ—Å—Ç–∏ existing_ips_map ---
    - name: üêû DEBUG ‚Äî existing_ips_map (—Ç–µ–∫—É—â–∏–µ IP –ø–æ –¥–æ–º–µ–Ω–∞–º)
      debug:
        var: existing_ips_map

    - name: üöÄ –°–æ–∑–¥–∞—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ A-–∑–∞–ø–∏—Å–∏ (–¥–ª—è apex-–¥–æ–º–µ–Ω–∞)
      uri:
        url: "https://api.porkbun.com/api/json/v3/dns/create/{{ domain }}"
        method: POST
        body:
          apikey: "{{ porkbun_api_key }}"
          secretapikey: "{{ porkbun_secret_api_key }}"
          name: ""
          type: "A"
          content: "{{ node.address }}"
          ttl: "300"
        body_format: json
        status_code: 200
      loop: "{{ active_nodes | product(domains_to_process) | list }}"
      loop_control:
        loop_var: pair
        label: "{{ pair.1 }} ‚Üí {{ pair.0.address }}"
      vars:
        node: "{{ pair.0 }}"
        domain: "{{ pair.1 }}"
        existing_ips: "{{ existing_ips_map[domain] | default([]) | map('trim') | list }}"
        active_ip: "{{ node.address | trim }}"
      when:
        - active_nodes | length > 0
        - active_ip not in existing_ips
      register: create_results

    # --- –î–ï–ë–ê–ì: –°—Ä–∞–≤–Ω–µ–Ω–∏–µ IP –ø–æ –¥–æ–º–µ–Ω–∞–º ---
    - name: üêû DEBUG ‚Äî –°—Ä–∞–≤–Ω–µ–Ω–∏–µ IP –ø–æ –¥–æ–º–µ–Ω—É
      debug:
        msg: |-
          –î–æ–º–µ–Ω: {{ domain }}
          –ê–∫—Ç–∏–≤–Ω—ã–µ IP: {{ active_ips }}
          –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ IP: {{ existing_ips }}
          –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ IP: {{ missing_ips }}
      loop: "{{ domains_to_process }}"
      loop_control:
        label: "{{ domain }}"
      vars:
        domain: "{{ item }}"
        existing_ips: "{{ existing_ips_map[item] | default([]) | map('trim') | list }}"
        active_ips: "{{ active_nodes | map(attribute='address') | map('trim') | list | unique }}"
        missing_ips: "{{ active_ips | difference(existing_ips) }}"

    # --- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: —Å–∫–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–µ–π —Å–æ–∑–¥–∞–Ω–æ –ø–æ –∫–∞–∂–¥–æ–º—É –¥–æ–º–µ–Ω—É ---
    - name: ‚úÖ –£—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω—ã –∑–∞–ø–∏—Å–∏ ‚Äî —Å–≤–æ–¥–∫–∞ –ø–æ –¥–æ–º–µ–Ω–∞–º
      debug:
        msg: "‚úÖ –í –¥–æ–º–µ–Ω–µ {{ domain }} —Å–æ–∑–¥–∞–Ω–æ A-–∑–∞–ø–∏—Å–µ–π: {{ count }}"
      loop: "{{ domains_to_process }}"
      loop_control:
        label: "{{ domain }}"
      vars:
        domain: "{{ item }}"
        count: >-
          {% set records = create_results.results | default([]) %}
          {% set total = 0 %}
          {% for rec in records %}
            {% if rec.changed is defined and rec.changed and rec.item is defined and rec.item | length >= 2 and rec.item[1] == domain %}
              {% set total = total + 1 %}
            {% endif %}
          {% endfor %}
          {{ total }}

    # --- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: –µ—Å–ª–∏ —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–µ—á–µ–≥–æ ---
    - name: ‚ÑπÔ∏è –ó–∞–ø–∏—Å–∏ –Ω–µ —Ç—Ä–µ–±—É—é—Ç—Å—è ‚Äî –≤—Å–µ IP —É–∂–µ –µ—Å—Ç—å
      debug:
        msg: "‚ÑπÔ∏è –í—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –Ω–æ–¥—ã —É–∂–µ –∏–º–µ—é—Ç A-–∑–∞–ø–∏—Å–∏ –≤ –¥–æ–º–µ–Ω–µ {{ domain }}"
      loop: "{{ domains_to_process }}"
      loop_control:
        label: "{{ domain }}"
      vars:
        domain: "{{ item }}"
        existing_ips: "{{ existing_ips_map[item] | default([]) | map('trim') | list }}"
        active_ips: "{{ active_nodes | map(attribute='address') | map('trim') | list | unique }}"
        missing: "{{ active_ips | difference(existing_ips) }}"
      when: missing | length == 0

    # --- –§–ò–ù–ê–õ: –ò—Ç–æ–≥–æ–≤–∞—è —Å–≤–æ–¥–∫–∞ ---
    - name: üìä –ò—Ç–æ–≥–æ–≤–∞—è —Å–≤–æ–¥–∫–∞
      debug:
        msg: |-

          –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è DNS –∑–∞–≤–µ—Ä—à–µ–Ω–∞.

          –ê–∫—Ç–∏–≤–Ω—ã—Ö –Ω–æ–¥ {{ active_nodes | length }}

          –¶–µ–ª–µ–≤—ã—Ö –¥–æ–º–µ–Ω–æ–≤ {{ domains_to_process | length }}

      when: active_nodes | length > 0

    - name: üìä –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–µ —Ç—Ä–µ–±–æ–≤–∞–ª–∞—Å—å ‚Äî –Ω–æ–¥ –Ω–µ—Ç
      debug:
        msg: "‚ÑπÔ∏è –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–µ –ø—Ä–æ–≤–æ–¥–∏–ª–∞—Å—å ‚Äî –∞–∫—Ç–∏–≤–Ω—ã—Ö –Ω–æ–¥ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ."
      when: active_nodes | length == 0
