---
- name: ðŸ—‘ï¸ Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ A-Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð´Ð»Ñ Ð½ÐµÐ°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ… Ð½Ð¾Ð´ Remnawave Ð¸Ð· DNS Porkbun
  hosts: localhost
  gather_facts: no

  vars:
    # Ð Ð°Ð±Ð¾Ñ‚Ð°ÐµÐ¼ Ð½Ð°Ð¿Ñ€ÑÐ¼ÑƒÑŽ Ñ target_domains â€” ÑÑ‚Ð¾ Ð´Ð¾Ð¼ÐµÐ½Ñ‹ 2-Ð³Ð¾ ÑƒÑ€Ð¾Ð²Ð½Ñ (apex)
    domains_to_process: "{{ target_domains }}"

  tasks:

    # --- Ð¨ÐÐ“ 1: ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÑÐ¿Ð¸ÑÐ¾Ðº Ð²ÑÐµÑ… Ð½Ð¾Ð´ Ð¸Ð· Remnawave API ---
    - name: ðŸŒ ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð²ÑÐµ Ð½Ð¾Ð´Ñ‹ Ð¸Ð· Remnawave
      uri:
        url: "https://{{ remnawave_domain }}/api/nodes"
        method: GET
        headers:
          Authorization: "Bearer {{ remnawave_token }}"
        return_content: yes
        timeout: 30
      register: remnawave_response
      until: remnawave_response.status == 200
      retries: 3
      delay: 5

    - name: âŒ ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ð¾ÑˆÐ¸Ð±ÐºÑƒ Remnawave API
      fail:
        msg: "Remnawave API Ð²ÐµÑ€Ð½ÑƒÐ» Ð¾ÑˆÐ¸Ð±ÐºÑƒ: {{ remnawave_response.json.message | default('Unknown error') }}"
      when: remnawave_response.json is defined and remnawave_response.json.errorCode is defined

    - name: ðŸ§© Ð˜Ð·Ð²Ð»ÐµÑ‡ÑŒ Ð²ÑÐµ Ð½Ð¾Ð´Ñ‹
      set_fact:
        all_nodes: "{{ remnawave_response.json.response | list }}"

    - name: ðŸ§© Ð˜Ð·Ð²Ð»ÐµÑ‡ÑŒ Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ðµ Ð½Ð¾Ð´Ñ‹ (isNodeOnline == true)
      set_fact:
        active_nodes: >-
          {{
            all_nodes
            | selectattr('isNodeOnline', 'equalto', true)
            | list
          }}

    - name: ðŸ§© Ð˜Ð·Ð²Ð»ÐµÑ‡ÑŒ Ð½ÐµÐ°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ðµ Ð½Ð¾Ð´Ñ‹ (isNodeOnline == false)
      set_fact:
        inactive_nodes: >-
          {{
            all_nodes
            | selectattr('isNodeOnline', 'equalto', false)
            | list
          }}

    - name: ðŸ“„ Ð’Ñ‹Ð²ÐµÑÑ‚Ð¸ ÑÐ¿Ð¸ÑÐ¾Ðº Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ… Ð½Ð¾Ð´
      debug:
        msg: |-
          ÐÐšÐ¢Ð˜Ð’ÐÐ«Ð• ÐÐžÐ”Ð« ({{ active_nodes | length }} ÑˆÑ‚.):
          {% for node in active_nodes %}
          {{ "%2d" % loop.index }}) {{ node.name }} â†’ {{ node.address }}
          {% endfor %}
      when: active_nodes | length > 0

    - name: ðŸ“„ Ð’Ñ‹Ð²ÐµÑÑ‚Ð¸ ÑÐ¿Ð¸ÑÐ¾Ðº Ð½ÐµÐ°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ… Ð½Ð¾Ð´
      debug:
        msg: |-
          ÐÐ•ÐÐšÐ¢Ð˜Ð’ÐÐ«Ð• ÐÐžÐ”Ð« ({{ inactive_nodes | length }} ÑˆÑ‚.):
          {% for node in inactive_nodes %}
          {{ "%2d" % loop.index }}) {{ node.name }} â†’ {{ node.address }}
          {% endfor %}
      when: inactive_nodes | length > 0

    - name: ðŸŸ¡ ÐÐµÑ‚ Ð½ÐµÐ°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ… Ð½Ð¾Ð´ â€” Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼ DNS-Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸
      debug:
        msg: "ÐÐµÑ‚ Ð½ÐµÐ°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ… Ð½Ð¾Ð´ Ð² Remnawave. ÐÐ¸Ñ‡ÐµÐ³Ð¾ ÑƒÐ´Ð°Ð»ÑÑ‚ÑŒ Ð½Ðµ Ð½ÑƒÐ¶Ð½Ð¾."
      when: inactive_nodes | length == 0

    # --- Ð¨ÐÐ“ 2: Ð”Ð»Ñ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ Ð´Ð¾Ð¼ÐµÐ½Ð° Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð²ÑÐµ DNS-Ð·Ð°Ð¿Ð¸ÑÐ¸ ---
    - name: ðŸ” ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð²ÑÐµ DNS-Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð´Ð»Ñ Ð´Ð¾Ð¼ÐµÐ½Ð°
      uri:
        url: "https://api.porkbun.com/api/json/v3/dns/retrieve/{{ item }}"
        method: POST
        body:
          apikey: "{{ porkbun_api_key }}"
          secretapikey: "{{ porkbun_secret_api_key }}"
        body_format: json
        return_content: yes
      register: dns_retrieve_results
      ignore_errors: yes
      loop: "{{ domains_to_process }}"
      loop_control:
        label: "{{ item }}"

    # --- Ð¨ÐÐ“ 3: ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ð¾ÑˆÐ¸Ð±ÐºÐ¸ Porkbun API ---
    - name: âŒ ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ð¾ÑˆÐ¸Ð±ÐºÑƒ Porkbun API Ð´Ð»Ñ Ð´Ð¾Ð¼ÐµÐ½Ð°
      fail:
        msg: "Porkbun API error for {{ item }}: {{ result.json.message | default('Unknown') }}"
      when: result.json is defined and result.json.status != "SUCCESS"
      loop: "{{ domains_to_process }}"
      loop_control:
        label: "{{ item }}"
      vars:
        result: "{{ dns_retrieve_results.results | selectattr('item', 'equalto', item) | first }}"

    # --- Ð¨ÐÐ“ 4: ÐŸÐ¾ÑÑ‚Ñ€Ð¾Ð¸Ñ‚ÑŒ existing_a_records_map (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ A-Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð´Ð»Ñ apex-Ð´Ð¾Ð¼ÐµÐ½Ð°) ---
    - name: ðŸ§© ÐŸÐ¾ÑÑ‚Ñ€Ð¾Ð¸Ñ‚ÑŒ existing_a_records_map
      set_fact:
        existing_a_records_map: >-
          {{
            existing_a_records_map | default({}) | combine({
              item: (
                (
                  (dns_retrieve_results.results | selectattr('item', 'equalto', item) | first | default({}))
                  .json.records | default([])
                )
                | selectattr('type', 'equalto', 'A')
                | selectattr('name', 'equalto', item)  # Ð¢Ð¾Ð»ÑŒÐºÐ¾ apex-Ð´Ð¾Ð¼ÐµÐ½
                | map(attribute='content') | list
                | zip(
                  (dns_retrieve_results.results | selectattr('item', 'equalto', item) | first | default({}))
                  .json.records | default([])
                  | selectattr('type', 'equalto', 'A')
                  | selectattr('name', 'equalto', item)  # Ð¢Ð¾Ð»ÑŒÐºÐ¾ apex-Ð´Ð¾Ð¼ÐµÐ½
                  | map(attribute='id') | list
                )
                | list
              )
            })
          }}
      loop: "{{ domains_to_process }}"
      loop_control:
        label: "{{ item }}"

    # --- Ð”Ð•Ð‘ÐÐ“: Ð’Ñ‹Ð²ÐµÑÑ‚Ð¸ existing_a_records_map ---
    - name: ðŸž DEBUG â€” existing_a_records_map (IP Ð¸ ID Ð·Ð°Ð¿Ð¸ÑÐµÐ¹ Ð¿Ð¾ Ð´Ð¾Ð¼ÐµÐ½Ð°Ð¼)
      debug:
        var: existing_a_records_map

    # --- Ð¨ÐÐ“ 5: Ð˜Ð·Ð²Ð»ÐµÑ‡ÑŒ Ð¼Ð½Ð¾Ð¶ÐµÑÑ‚Ð²Ð¾ IP-Ð°Ð´Ñ€ÐµÑÐ¾Ð² Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ… Ð½Ð¾Ð´ ---
    - name: ðŸ§© Ð˜Ð·Ð²Ð»ÐµÑ‡ÑŒ Ð¼Ð½Ð¾Ð¶ÐµÑÑ‚Ð²Ð¾ Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ… IP
      set_fact:
        active_ips_set: "{{ active_nodes | map(attribute='address') | list | unique }}"

    # --- Ð¨ÐÐ“ 6: ÐÐ°Ð¹Ñ‚Ð¸ Ð»Ð¸ÑˆÐ½Ð¸Ðµ A-Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð´Ð»Ñ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ (IP Ð½ÐµÐ°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ… Ð½Ð¾Ð´, Ð½Ð°Ñ…Ð¾Ð´ÑÑ‰Ð¸ÐµÑÑ Ð² DNS) ---
    - name: ðŸ§© ÐÐ°Ð¹Ñ‚Ð¸ Ð»Ð¸ÑˆÐ½Ð¸Ðµ A-Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð´Ð»Ñ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ
      set_fact:
        orphaned_records: >-
          {{
            orphaned_records | default({}) | combine({
              domain: (
                (existing_a_records_map[domain] | default([]))
                | selectattr(0, 'in', inactive_nodes | map(attribute='address') | list) # IP ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ Ð½ÐµÐ°ÐºÑ‚Ð¸Ð²Ð½Ð¾Ð¹ Ð½Ð¾Ð´Ðµ
                | list
              )
            })
          }}
      loop: "{{ domains_to_process }}"
      loop_control:
        label: "{{ domain }}"
      vars:
        domain: "{{ item }}"

    # --- Ð”Ð•Ð‘ÐÐ“: Ð’Ñ‹Ð²ÐµÑÑ‚Ð¸ Ð½Ð°Ð¹Ð´ÐµÐ½Ð½Ñ‹Ðµ Ð»Ð¸ÑˆÐ½Ð¸Ðµ Ð·Ð°Ð¿Ð¸ÑÐ¸ ---
    - name: ðŸž DEBUG â€” ÐÐ°Ð¹Ð´ÐµÐ½Ð½Ñ‹Ðµ Ð»Ð¸ÑˆÐ½Ð¸Ðµ A-Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð´Ð»Ñ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ
      debug:
        msg: |-
          Ð”Ð¾Ð¼ÐµÐ½: {{ domain }}
          Ð›Ð¸ÑˆÐ½Ð¸Ðµ Ð·Ð°Ð¿Ð¸ÑÐ¸ (IP ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‚ Ð½ÐµÐ°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ð¼ Ð½Ð¾Ð´Ð°Ð¼): {{ orphaned_records[domain] | length }} ÑˆÑ‚.
          {% for ip, id in orphaned_records[domain] %}
          {{ "%2d" % loop.index }}) {{ ip }} (ID: {{ id }})
          {% endfor %}
      loop: "{{ domains_to_process }}"
      loop_control:
        label: "{{ domain }}"
      when: orphaned_records[domain] | default([]) | length > 0

    # --- Ð¨ÐÐ“ 7: ÐŸÐ¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ðµ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾) ---
    - name: ðŸ›‘ ÐŸÐ¾Ð´Ñ‚Ð²ÐµÑ€Ð´Ð¸Ñ‚Ðµ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ðµ Ð·Ð°Ð¿Ð¸ÑÐµÐ¹
      pause:
        prompt: "ÐÐ°Ð¹Ð´ÐµÐ½Ð¾ {{ total_records }} Ð»Ð¸ÑˆÐ½Ð¸Ñ… A-Ð·Ð°Ð¿Ð¸ÑÐµÐ¹ Ð´Ð»Ñ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ. Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ 'yes' Ð´Ð»Ñ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ñ, Ð¸Ð»Ð¸ Ð½Ð°Ð¶Ð¼Ð¸Ñ‚Ðµ Ctrl+C Ð´Ð»Ñ Ð¾Ñ‚Ð¼ÐµÐ½Ñ‹"
      register: confirmation_pause
      vars:
        total_records: >-
          {% set total = 0 %}
          {% for domain in domains_to_process %}
            {% set records = orphaned_records[domain] | default([]) %}
            {% set total = total + records | length %}
          {% endfor %}
          {{ total }}
      when: >-
        {% set any_records = false %}
        {% for domain in domains_to_process %}
          {% if orphaned_records[domain] | default([]) | length > 0 %}
            {% set any_records = true %}
          {% endif %}
        {% endfor %}
        {{ any_records }}

    # --- Ð¨ÐÐ“ 8: Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð»Ð¸ÑˆÐ½Ð¸Ðµ A-Ð·Ð°Ð¿Ð¸ÑÐ¸ ---
    - name: ðŸ—‘ï¸ Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð»Ð¸ÑˆÐ½Ð¸Ðµ A-Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð¸Ð· DNS
      uri:
        url: "https://api.porkbun.com/api/json/v3/dns/delete/{{ domain }}/{{ record_id }}"
        method: POST
        body:
          apikey: "{{ porkbun_api_key }}"
          secretapikey: "{{ porkbun_secret_api_key }}"
        body_format: json
        status_code: 200
      register: delete_results
      loop: >-
        {% set result = [] %}
        {% for domain in domains_to_process %}
          {% for ip, record_id in orphaned_records[domain] | default([]) %}
            {% set result = result.append({'domain': domain, 'ip': ip, 'id': record_id}) %}
          {% endfor %}
        {% endfor %}
        {{ result }}
      loop_control:
        loop_var: item
        label: "{{ item.domain }} â†’ {{ item.ip }} (ID: {{ item.id }})"

    # --- Ð¨ÐÐ“ 9: ÐžÑ‚Ñ‡ÐµÑ‚ Ð¾Ð± ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ð¸ ---
    - name: âœ… ÐžÑ‚Ñ‡ÐµÑ‚ Ð¾Ð± ÑƒÐ´Ð°Ð»ÐµÐ½Ð½Ñ‹Ñ… Ð·Ð°Ð¿Ð¸ÑÑÑ…
      debug:
        msg: |-
          âœ… Ð£Ð´Ð°Ð»ÐµÐ½Ð¾ A-Ð·Ð°Ð¿Ð¸ÑÐµÐ¹ Ð´Ð»Ñ Ð´Ð¾Ð¼ÐµÐ½Ð° {{ domain }}: {{ deleted_count }} ÑˆÑ‚.
          {% for del in domain_delete_results %}
          {{ "%2d" % loop.index }}) {{ del.ip }} (ID: {{ del.id }})
          {% endfor %}
      loop: "{{ domains_to_process }}"
      loop_control:
        label: "{{ domain }}"
      vars:
        domain_delete_results: >-
          {{
            delete_results.results
            | selectattr('item.domain', 'equalto', item)
            | selectattr('changed', 'true')
            | map(attribute='item')
            | list
          }}
        deleted_count: "{{ domain_delete_results | length }}"
      when: domain_delete_results | length > 0

    # --- Ð¨ÐÐ“ 10: ÐžÑˆÐ¸Ð±ÐºÐ¸ Ð¿Ñ€Ð¸ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ð¸ ---
    - name: âš ï¸ ÐžÑˆÐ¸Ð±ÐºÐ¸ Ð¿Ñ€Ð¸ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ð¸ Ð·Ð°Ð¿Ð¸ÑÐµÐ¹
      debug:
        msg: |-
          âŒ ÐžÑˆÐ¸Ð±ÐºÐ¸ Ð¿Ñ€Ð¸ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ð¸ Ð´Ð»Ñ Ð´Ð¾Ð¼ÐµÐ½Ð° {{ domain }}:
          {% for del in domain_delete_errors %}
          {{ "%2d" % loop.index }}) {{ del.ip }} (ID: {{ del.id }}) - {{ del.delete_result.status }}: {{ del.delete_result.status_text }}
          {% endfor %}
      loop: "{{ domains_to_process }}"
      loop_control:
        label: "{{ domain }}"
      vars:
        domain_delete_errors: >-
          {{
            delete_results.results
            | selectattr('item.domain', 'equalto', item)
            | selectattr('failed', 'true')
            | map(attribute='item')
            | list
          }}
      when: domain_delete_errors | length > 0

    # --- Ð¤Ð˜ÐÐÐ›: Ð˜Ñ‚Ð¾Ð³Ð¾Ð²Ð°Ñ ÑÐ²Ð¾Ð´ÐºÐ° ---
    - name: ðŸ“Š Ð˜Ñ‚Ð¾Ð³Ð¾Ð²Ð°Ñ ÑÐ²Ð¾Ð´ÐºÐ°
      debug:
        msg: |-
          
          ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° DNS Ð¾Ñ‚ Ð½ÐµÐ°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ… Ð½Ð¾Ð´ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°.
          
          Ð’ÑÐµÐ³Ð¾ Ð½Ð¾Ð´: {{ all_nodes | length }}
          ÐÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ…: {{ active_nodes | length }}
          ÐÐµÐ°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ…: {{ inactive_nodes | length }}
          
          Ð¦ÐµÐ»ÐµÐ²Ñ‹Ñ… Ð´Ð¾Ð¼ÐµÐ½Ð¾Ð²: {{ domains_to_process | length }}
          
          {% set total_deleted = 0 %}
          {% for domain in domains_to_process %}
            {% set deleted = (delete_results.results | selectattr('item.domain', 'equalto', domain) | selectattr('changed', 'true') | list) | length %}
            {% set total_deleted = total_deleted + deleted %}
          {% endfor %}
          Ð£Ð´Ð°Ð»ÐµÐ½Ð¾ A-Ð·Ð°Ð¿Ð¸ÑÐµÐ¹: {{ total_deleted }}

      when: true

    - name: ðŸ“Š ÐÐ¸Ñ‡ÐµÐ³Ð¾ Ð½Ðµ ÑƒÐ´Ð°Ð»ÑÐ»Ð¾ÑÑŒ
      debug:
        msg: "â„¹ï¸ ÐÐ¸Ñ‡ÐµÐ³Ð¾ Ð½Ðµ ÑƒÐ´Ð°Ð»ÑÐ»Ð¾ÑÑŒ â€” Ð½ÐµÐ°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ… Ð½Ð¾Ð´ Ð¸Ð»Ð¸ ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ñ… Ð¸Ð¼ A-Ð·Ð°Ð¿Ð¸ÑÐµÐ¹ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾."
      when: >-
        {% set any_records = false %}
        {% for domain in domains_to_process %}
          {% if orphaned_records[domain] | default([]) | length > 0 %}
            {% set any_records = true %}
          {% endif %}
        {% endfor %}
        not any_records
