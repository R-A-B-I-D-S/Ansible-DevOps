---
- name: âŒ Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ A-Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð½ÐµÐ°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ… Ð½Ð¾Ð´
  hosts: localhost
  gather_facts: no

  vars:
    domains_to_process: "{{ target_domains }}"

  tasks:

    # --- Ð¨ÐÐ“ 1: ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÑÐ¿Ð¸ÑÐ¾Ðº Ð²ÑÐµÑ… Ð½Ð¾Ð´ Ð¸Ð· Remnawave ---
    - name: ðŸŒ ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð²ÑÐµ Ð½Ð¾Ð´Ñ‹ Ð¸Ð· Remnawave
      uri:
        url: "https://{{ remnawave_domain }}/api/nodes"
        method: GET
        headers:
          Authorization: "Bearer {{ remnawave_token }}"
        return_content: yes
      register: remnawave_response

    - name: âŒ ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ð¾ÑˆÐ¸Ð±ÐºÑƒ Remnawave API
      fail:
        msg: "Remnawave API Ð²ÐµÑ€Ð½ÑƒÐ» Ð¾ÑˆÐ¸Ð±ÐºÑƒ: {{ remnawave_response.json.message | default('Unknown error') }}"
      when: remnawave_response.json is defined and remnawave_response.json.errorCode is defined

    - name: ðŸ§© Ð˜Ð·Ð²Ð»ÐµÑ‡ÑŒ Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ðµ Ð½Ð¾Ð´Ñ‹
      set_fact:
        active_nodes: >-
          {{
            remnawave_response.json.response
            | selectattr('isNodeOnline', 'equalto', true)
            | map(attribute='address')
            | map('trim')
            | list
          }}

    - name: ðŸ“„ Ð’Ñ‹Ð²ÐµÑÑ‚Ð¸ Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ðµ Ð½Ð¾Ð´Ñ‹
      debug:
        msg: "ÐÐºÑ‚Ð¸Ð²Ð½Ñ‹Ðµ Ð½Ð¾Ð´Ñ‹: {{ active_nodes }}"

    # --- Ð¨ÐÐ“ 2: ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ DNS-Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð´Ð»Ñ Ð´Ð¾Ð¼ÐµÐ½Ð° ---
    - name: ðŸ” ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ DNS-Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð´Ð¾Ð¼ÐµÐ½Ð°
      uri:
        url: "https://api.porkbun.com/api/json/v3/dns/retrieve/{{ item }}"
        method: POST
        body:
          apikey: "{{ porkbun_api_key }}"
          secretapikey: "{{ porkbun_secret_api_key }}"
        body_format: json
        return_content: yes
      register: dns_retrieve_results
      loop: "{{ domains_to_process }}"
      loop_control:
        label: "{{ item }}"

    - name: âŒ ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ð¾ÑˆÐ¸Ð±ÐºÐ¸ Porkbun API
      fail:
        msg: "ÐžÑˆÐ¸Ð±ÐºÐ° Porkbun Ð´Ð»Ñ {{ item }}: {{ result.json.message | default('Unknown') }}"
      loop: "{{ domains_to_process }}"
      loop_control:
        label: "{{ item }}"
      vars:
        result: "{{ dns_retrieve_results.results | selectattr('item', 'equalto', item) | first }}"
      when: result.json is defined and result.json.status != "SUCCESS"

    # --- Ð¨ÐÐ“ 3: ÐÐ°Ð¹Ñ‚Ð¸ A-Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð½ÐµÐ°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ… Ð½Ð¾Ð´ ---
    - name: ðŸ§© ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ñ‚ÑŒ A-Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð½ÐµÐ°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ… Ð½Ð¾Ð´
      set_fact:
        inactive_records: >-
          {{
            inactive_records | default([]) + (
              (dns_retrieve_results.results | selectattr('item', 'equalto', domain) | first).json.records
              | selectattr('type', 'equalto', 'A')
              | selectattr('name', 'equalto', domain)
              | rejectattr('content', 'in', active_nodes)
              | list
            )
          }}
      loop: "{{ domains_to_process }}"
      loop_control:
        label: "{{ item }}"
      vars:
        domain: "{{ item }}"

    - name: ðŸ“„ Ð’Ñ‹Ð²ÐµÑÑ‚Ð¸ A-Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð½ÐµÐ°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ… Ð½Ð¾Ð´
      debug:
        msg: "Ð”Ð»Ñ Ð´Ð¾Ð¼ÐµÐ½Ð° {{ item }} Ð±ÑƒÐ´ÑƒÑ‚ ÑƒÐ´Ð°Ð»ÐµÐ½Ñ‹: {{ inactive_records }}"
      loop: "{{ domains_to_process }}"
      loop_control:
        label: "{{ item }}"
      vars:
        inactive_records: "{{ inactive_records | selectattr('name', 'equalto', item) | list }}"

    - name: ðŸ—‘ï¸ Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ A-Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð½ÐµÐ°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ… Ð½Ð¾Ð´ Ñ‡ÐµÑ€ÐµÐ· Porkbun
      vars:
        domain_inactive_records: >-
          {{
            (dns_retrieve_results.results | selectattr('item', 'equalto', domain) | first).json.records
            | selectattr('type', 'equalto', 'A')
            | rejectattr('content', 'in', active_nodes)
            | list
          }}
      loop: "{{ domains_to_process }}"
      loop_control:
        loop_var: domain
      when: domain_inactive_records | length > 0
      block:

    - name: ðŸ“„ Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð´Ð»Ñ Ð´Ð¾Ð¼ÐµÐ½Ð° {{ domain }}
      debug:
        msg: "Ð£Ð´Ð°Ð»ÑÐµÐ¼ {{ item.content }} (ID {{ item.id }})"
      loop: "{{ domain_inactive_records }}"
      loop_control:
        label: "{{ item.content }}"

    - name: ðŸ—‘ï¸ API Ð²Ñ‹Ð·Ð¾Ð² ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ Ð·Ð°Ð¿Ð¸ÑÐ¸
      uri:
        url: "https://api.porkbun.com/api/json/v3/dns/delete/{{ domain }}/{{ item.id }}"
        method: POST
        body:
          apikey: "{{ porkbun_api_key }}"
          secretapikey: "{{ porkbun_secret_api_key }}"
        body_format: json
        status_code: 200
      loop: "{{ domain_inactive_records }}"
      loop_control:
        label: "{{ item.content }}"

    - name: âœ… ÐžÑ‚Ñ‡Ñ‘Ñ‚ Ð¾Ð± ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ð¸
      debug:
        msg: "âœ… Ð£Ð´Ð°Ð»ÐµÐ½Ð° Ð·Ð°Ð¿Ð¸ÑÑŒ {{ item.1.name }} â†’ {{ item.1.content }}"
      loop: "{{ domains_to_process | product(inactive_records) | list }}"
      loop_control:
        label: "{{ item.0 }} â†’ {{ item.1.content }}"
      vars:
        domain: "{{ item.0 }}"
        record: "{{ item.1 }}"
        inactive_records: >-
          {{
            (dns_retrieve_results.results | selectattr('item', 'equalto', domain) | first).json.records
            | selectattr('type', 'equalto', 'A')
            | rejectattr('content', 'in', active_nodes)
            | list
          }}
