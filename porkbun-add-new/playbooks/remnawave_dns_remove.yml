---
- name: ðŸ—‘ï¸ Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ A-Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð½ÐµÐ°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ… Ð½Ð¾Ð´
  hosts: localhost
  gather_facts: no

  vars:
    domains_to_process: "{{ target_domains }}"

  tasks:
    # --- Ð¨ÐÐ“ 1: ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÑÐ¿Ð¸ÑÐ¾Ðº Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ… Ð½Ð¾Ð´ ---
    - name: ðŸŒ ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ðµ Ð½Ð¾Ð´Ñ‹ Ð¸Ð· Remnawave
      uri:
        url: "https://{{ remnawave_domain }}/api/nodes"
        method: GET
        headers:
          Authorization: "Bearer {{ remnawave_token }}"
        return_content: yes
        timeout: 30
      register: remnawave_response
      until: remnawave_response.status == 200
      retries: 3
      delay: 5

    - name: âŒ ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ð¾ÑˆÐ¸Ð±ÐºÑƒ Remnawave API
      fail:
        msg: "Remnawave API Ð²ÐµÑ€Ð½ÑƒÐ» Ð¾ÑˆÐ¸Ð±ÐºÑƒ: {{ remnawave_response.json.message | default('Unknown error') }}"
      when: remnawave_response.json is defined and remnawave_response.json.errorCode is defined

    - name: ðŸ§© Ð˜Ð·Ð²Ð»ÐµÑ‡ÑŒ Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ðµ Ð½Ð¾Ð´Ñ‹
      set_fact:
        active_nodes: >-
          {{
            remnawave_response.json.response
            | selectattr('isNodeOnline', 'equalto', true)
            | list
          }}

    - name: ðŸŸ¡ ÐÐµÑ‚ Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ… Ð½Ð¾Ð´ â€” Ð½Ð¸Ñ‡ÐµÐ³Ð¾ ÑƒÐ´Ð°Ð»ÑÑ‚ÑŒ Ð½Ðµ Ð½ÑƒÐ¶Ð½Ð¾
      debug:
        msg: "ÐÐµÑ‚ Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ… Ð½Ð¾Ð´. Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ A-Ð·Ð°Ð¿Ð¸ÑÐµÐ¹ Ð½Ðµ Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ."
      when: active_nodes | length == 0

    # --- Ð¨ÐÐ“ 2: ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ðµ DNS A-Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð´Ð»Ñ Ð´Ð¾Ð¼ÐµÐ½Ð¾Ð² ---
    - name: ðŸ” ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð²ÑÐµ DNS-Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð´Ð»Ñ Ð´Ð¾Ð¼ÐµÐ½Ð°
      uri:
        url: "https://api.porkbun.com/api/json/v3/dns/retrieve/  {{ item }}"
        method: POST
        body:
          apikey: "{{ porkbun_api_key }}"
          secretapikey: "{{ porkbun_secret_api_key }}"
        body_format: json
        return_content: yes
      register: dns_retrieve_results
      loop: "{{ domains_to_process }}"
      loop_control:
        label: "{{ item }}"

    - name: ðŸ§© Ð¡Ð¾Ð±Ñ€Ð°Ñ‚ÑŒ Ð²ÑÐµ A-Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð¿Ð¾ Ð´Ð¾Ð¼ÐµÐ½Ð°Ð¼
      set_fact:
        all_a_records: >-
          {{
            all_a_records | default({}) | combine({
              item: (
                (dns_retrieve_results.results | selectattr('item', 'equalto', item) | first).json.records
                | selectattr('type', 'equalto', 'A')
                | selectattr('name', 'equalto', item)
                | list
              )
            })
          }}
      loop: "{{ domains_to_process }}"
      loop_control:
        label: "{{ item }}"

    # --- Ð¨ÐÐ“ 3: ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ñ‚ÑŒ Ð½ÐµÐ°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ðµ IP ---
    - name: ðŸ§© Ð’Ñ‹Ñ‡Ð¸ÑÐ»Ð¸Ñ‚ÑŒ IP Ð½ÐµÐ°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ… Ð½Ð¾Ð´
      set_fact:
        inactive_ips_map: >-
          {{
            inactive_ips_map | default({}) | combine({
              domain: (
                (all_a_records[domain] | map(attribute='content') | list)
                | difference(active_nodes | map(attribute='address') | list)
              )
            })
          }}
      loop: "{{ domains_to_process }}"
      loop_control:
        loop_var: domain

    - name: ðŸ“„ DEBUG â€” IP Ð½ÐµÐ°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ… Ð½Ð¾Ð´
      debug:
        var: inactive_ips_map

    # --- Ð¨ÐÐ“ 4: Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ A-Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð½ÐµÐ°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ… Ð½Ð¾Ð´ ---
    - name: ðŸš« Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ A-Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð½ÐµÐ°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ… Ð½Ð¾Ð´
      uri:
        url: "https://api.porkbun.com/api/json/v3/dns/delete/  {{ domain }}/{{ record.id }}"
        method: POST
        body:
          apikey: "{{ porkbun_api_key }}"
          secretapikey: "{{ porkbun_secret_api_key }}"
        body_format: json
        status_code: 200
      loop: "{{ domains_to_process | product([0]) | list }}"
      loop_control:
        loop_var: domain_pair
      vars:
        domain: "{{ domain_pair[0] }}"
        records_to_delete: >-
          {{
            all_a_records[domain]
            | selectattr('content', 'in', inactive_ips_map[domain])
            | list
          }}
      with_items: "{{ records_to_delete }}"
      loop_control:
        loop_var: record

    - name: âœ… ÐžÑ‚Ñ‡Ñ‘Ñ‚ Ð¾Ð± ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ð¸
      debug:
        msg: "Ð£Ð´Ð°Ð»ÐµÐ½Ð° Ð·Ð°Ð¿Ð¸ÑÑŒ {{ record.name }} â†’ {{ record.content }}"
      loop: "{{ domains_to_process | product([0]) | list }}"
      loop_control:
        loop_var: domain_pair
      vars:
        domain: "{{ domain_pair[0] }}"
        records_to_delete: >-
          {{
            all_a_records[domain]
            | selectattr('content', 'in', inactive_ips_map[domain])
            | list
          }}
      with_items: "{{ records_to_delete }}"
      loop_control:
        loop_var: record
