---
- name: üìã –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ A-–∑–∞–ø–∏—Å–∏ –¥–æ–º–µ–Ω–∞
  hosts: localhost
  gather_facts: no
  vars_files:
      - /etc/ansible/migration/inventory/porkbun.yml

  tasks:
      - name: üîç –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ DNS-–∑–∞–ø–∏—Å–∏ –∏–∑ Porkbun
        uri:
            url: "https://api.porkbun.com/api/json/v3/dns/retrieve/{{ porkbun_domain }}"
            method: POST
            body:
                apikey: "{{ porkbun_api_key }}"
                secretapikey: "{{ porkbun_secret_api_key }}"
            body_format: json
            return_content: yes
        register: dns_response

      - name: ‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä–∫–∞API –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É
        fail:
            msg: "‚ùå –û—à–∏–±–∫–∞ API Porkbun: {{ dns_response.json.status }} ‚Äî {{ dns_response.json.message | default('Unknown error') }}"
        when: dns_response.json is defined and dns_response.json.status != "SUCCESS"

      - name: üß© –ò–∑–≤–ª–µ—á—å –∏ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å A-–∑–∞–ø–∏—Å–∏
        set_fact:
            a_records: >-
                {{
                  dns_response.json.records
                  | selectattr('type', 'equalto', 'A')
                  | sort(attribute='name')
                  | list
                }}

      - name: üìÑ –í—ã–≤–µ—Å—Ç–∏ —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö A-–∑–∞–ø–∏—Å–µ–π
        debug:
            msg: |-
                –°–ü–ò–°–û–ö A-–ó–ê–ü–ò–°–ï–ô –î–õ–Ø {{ porkbun_domain }}

                {% for record in a_records %}
                {{ "%2d" % loop.index }}) {{ "%-30s" % record.name }} ‚Üí {{ record.content }}
                {% endfor %}
        when: a_records | length > 0

      - name: üü° –ù–µ—Ç A-–∑–∞–ø–∏—Å–µ–π
        debug:
            msg: |-
                üì≠ –ù–ï–¢ A-–ó–ê–ü–ò–°–ï–ô –¥–ª—è –¥–æ–º–µ–Ω–∞: {{ porkbun_domain }}
        when: a_records | length == 0
